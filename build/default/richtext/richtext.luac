
Ú‹
Äìlocal parser = require "richtext.parse"
local utf8 =require("richtext.utf8")

local M = {}

M.ALIGN_CENTER = hash("ALIGN_CENTER")
M.ALIGN_LEFT = hash("ALIGN_LEFT")
M.ALIGN_RIGHT = hash("ALIGN_RIGHT")
M.ALIGN_JUSTIFY = hash("ALIGN_JUSTIFY")

M.VALIGN_TOP = hash("VALIGN_TOP")
M.VALIGN_MIDDLE = hash("VALIGN_MIDDLE")
M.VALIGN_BOTTOM = hash("VALIGN_BOTTOM")


local V4_ZERO = vmath.vector4(0)
local V4_ONE = vmath.vector4(1)

local V3_ZERO = vmath.vector3(0)
local V3_ONE = vmath.vector3(1)

local id_counter = 0

local function new_id(prefix)
	id_counter = id_counter + 1
	return hash((prefix or "") .. tostring(id_counter))
end

local function round(v)
	if type(v) == "number" then
		return math.floor(v + 0.5)
	else
		return vmath.vector3(math.floor(v.x + 0.5), math.floor(v.y + 0.5), math.floor(v.z + 0.5))
	end
end


local function deepcopy(orig)
	local orig_type = type(orig)
	local copy
	if orig_type == 'table' then
		copy = {}
		for orig_key, orig_value in next, orig, nil do
			copy[deepcopy(orig_key)] = deepcopy(orig_value)
		end
	else -- number, string, boolean, etc
		copy = orig
	end
	return copy
end


local function get_trailing_whitespace(text)
	return text:match("^.-(%s*)$") or ""
end


local function get_space_width(font)
	return gui.get_text_metrics(font, " _").width - gui.get_text_metrics(font, "_").width
end


local function get_font(word, fonts)
	local font_settings = fonts[word.font]
	local font = nil
	if font_settings then
		if word.bold and word.italic then
			font = font_settings.bold_italic
		end
		if not font and word.bold then
			font = font_settings.bold
		end
		if not font and word.italic then
			font = font_settings.italic
		end
		if not font then
			font = font_settings.regular
		end
	end
	if not font then
		font = word.font
	end
	return font
end


local function get_layer(word, layers)
	local node = word.node
	if word.image then
		return layers.images[gui.get_texture(node)]
	elseif word.spine then
		return layers.spinescenes[gui.get_spine_scene(node)]
	end
	return layers.fonts[gui.get_font(node)]
end

-- compare two words and check that they have the same size, color, font and tags
local function compare_words(one, two)
	if one == nil
	or two == nil
	or one.size ~= two.size
	or one.color ~= two.color
	or one.shadow ~= two.shadow
	or one.outline ~= two.outline
	or one.font ~= two.font then
		return false
	end
	local one_tags, two_tags = one.tags, two.tags
	if one_tags == two_tags then
		return true
	end
	if one_tags == nil or two_tags == nil then
		return false
	end
	for k, v in pairs(one_tags) do
		if two_tags[k] ~= v then
			return false
		end
	end
	for k, v in pairs(two_tags) do
		if one_tags[k] ~= v then
			return false
		end
	end
	return true
end


-- position all words according to the line alignment and line width
-- the list of words will be empty after this function is called
local function position_words(words, line_width, line_height, position, settings)
	if settings.align == M.ALIGN_RIGHT then
		position.x = position.x - line_width
	elseif settings.align == M.ALIGN_CENTER then
		position.x = position.x - line_width / 2
	end

	local spacing = 0
	if settings.align == M.ALIGN_JUSTIFY then
		local words_width = 0
		local word_count = 0
		for i=1,#words do
			local word = words[i]
			if word.metrics.total_width > 0 then
				words_width = words_width + word.metrics.total_width
				word_count = word_count + 1
			end
		end
		if word_count > 1 then
			spacing = (settings.width - words_width) / (word_count - 1)
		end
	end
	for i=1,#words do
		local word = words[i]
		-- align spine animations to bottom of line since
		-- spine animations ignore pivot (always PIVOT_S)
		if word.spine then
			position.y = position.y - line_height
			gui.set_position(word.node, position)
			position.y = position.y + line_height
		elseif word.image and settings.image_pixel_grid_snap then
			gui.set_position(word.node, round(position))
		else
			gui.set_position(word.node, position)
		end
		position.x = position.x + word.metrics.total_width + spacing
		words[i] = nil
	end
end


--- Get the length of a text ignoring any tags except image tags
-- which are treated as having a length of 1
-- @param text String with text or a list of words (from richtext.create)
-- @return Length of text
function M.length(text)
	assert(text)
	if type(text) == "string" then
		return parser.length(text)
	else
		local count = 0
		for i=1,#text do
			local word = text[i]
			local is_text_node = not word.image and not word.spine
			count = count + (is_text_node and utf8.len(word.text) or 1)
		end
		return count
	end
end


local function create_box_node(word)
	local node = gui.new_box_node(V3_ZERO, V3_ZERO)
	gui.set_id(node, new_id("box"))
	gui.set_size_mode(node, gui.SIZE_MODE_AUTO)
	gui.set_texture(node, word.image.texture)
	gui.set_scale(node, vmath.vector3(word.size))
	gui.play_flipbook(node, hash(word.image.anim))

	-- get metrics of node based on image size
	local size = gui.get_size(node)
	local metrics = {}
	metrics.total_width = size.x * word.size
	metrics.width = size.x * word.size
	metrics.height = size.y * word.size
	return node, metrics
end


local function create_spine_node(word)
	local node = gui.new_spine_node(V3_ZERO, word.spine.scene)
	gui.set_id(node, new_id("spine"))
	gui.set_size_mode(node, gui.SIZE_MODE_AUTO)
	gui.set_scale(node, vmath.vector3(word.size))
	gui.play_spine_anim(node, word.spine.anim, gui.PLAYBACK_LOOP_FORWARD)

	local size = gui.get_size(node)
	local metrics = {}
	metrics.total_width = size.x
	metrics.width = size.x
	metrics.height = size.y
	return node, metrics
end


local function get_text_metrics(word, font, text)
	text = text or word.text
	font = font or word.font

	local metrics
	if utf8.len(text) == 0 then
		metrics = gui.get_text_metrics(font, "|")
		metrics.width = 0
		metrics.total_width = 0
		metrics.height = metrics.height * word.size
	else
		metrics = gui.get_text_metrics(font, text)
		metrics.width = metrics.width * word.size
		metrics.height = metrics.height * word.size

		-- get width of text with trailing whitespace included
		local trailing_whitespace = get_trailing_whitespace(word.text)
		if #trailing_whitespace > 0 then
			metrics.total_width = metrics.width + (#trailing_whitespace * get_space_width(font) * word.size)
		else
			metrics.total_width = metrics.width
		end
	end
	return metrics
end


local function create_text_node(word, font, metrics)
	local node = gui.new_text_node(V3_ZERO, word.text)
	gui.set_id(node, new_id("textnode"))
	gui.set_font(node, font)
	gui.set_color(node, word.color)
	if word.shadow then gui.set_shadow(node, word.shadow) end
	if word.outline then gui.set_outline(node, word.outline) end
	gui.set_scale(node, V3_ONE * word.size)

	metrics = metrics or get_text_metrics(word, font)
	gui.set_size_mode(node, gui.SIZE_MODE_MANUAL)
	gui.set_size(node, vmath.vector3(metrics.width, metrics.height, 0))
	return node, metrics
end


local function combine_node(previous_word, word, metrics)
	local text = previous_word.text .. word.text
	previous_word.text = text
	previous_word.metrics = metrics
	gui.set_size(previous_word.node, vmath.vector3(metrics.width, metrics.height, 0))
	gui.set_text(previous_word.node, text)
end


local function create_node(word, parent, font, node, metrics)
	if word.image then
		if not node then
			node, metrics = create_box_node(word)
		end
	elseif word.spine then
		if not node then
			node, metrics = create_spine_node(word)
		end
	else
		node, metrics = create_text_node(word, font, metrics)
	end
	gui.set_parent(node, parent)
	gui.set_inherit_alpha(node, true)
	return node, metrics
end


local function measure_node(word, font, previous_word)
	local node, metrics, combined_metrics
	if word.image then
		node, metrics = create_box_node(word)
	elseif word.spine then
		node, metrics = create_spine_node(word)
	else
		metrics = get_text_metrics(word, font)
		if previous_word then
			combined_metrics = get_text_metrics(word, font, previous_word.text .. word.text)
		end
	end
	return metrics, combined_metrics, node
end



--- Create rich text gui nodes from text
-- @param text The text to create rich text nodes from
-- @param font The default font
-- @param settings Optional settings table (refer to documentation for details)
-- @return words
-- @return metrics
function M.create(text, font, settings)
	assert(text, "You must provide a text")
	assert(font, "You must provide a font")
	settings = settings or {}
	settings.align = settings.align or M.ALIGN_LEFT
	settings.valign = settings.valign or M.VALIGN_TOP
	settings.fonts = settings.fonts or {}
	settings.fonts[font] = settings.fonts[font] or { regular = hash(font) }
	settings.layers = settings.layers or {}
	settings.layers.fonts = settings.layers.fonts or {}
	settings.layers.images = settings.layers.images or {}
	settings.layers.spinescenes = settings.layers.spinescenes or {}
	settings.color = settings.color or V4_ONE
	settings.shadow = settings.shadow or V4_ZERO
	settings.outline = settings.outline or V4_ZERO
	settings.position = settings.position or V3_ZERO
	settings.line_spacing = settings.line_spacing or 1
	settings.paragraph_spacing = settings.paragraph_spacing or 0.5
	settings.image_pixel_grid_snap = settings.image_pixel_grid_snap or false
	settings.combine_words = settings.combine_words or false
	if settings.align == M.ALIGN_JUSTIFY and not settings.width then
		error("Width must be specified if text should be justified")
	end

	local line_increment_before = 0
	local line_increment_after = 1
	local pivot = gui.PIVOT_NW
	if settings.valign == M.VALIGN_MIDDLE then
		line_increment_before = 0.5
		line_increment_after = 0.5
		pivot = gui.PIVOT_W
	elseif settings.valign == M.VALIGN_BOTTOM then
		line_increment_before = 1
		line_increment_after = 0
		pivot = gui.PIVOT_SW
	end

	-- default settings for a word
	-- will be assigned to each word unless tags override the values
	local word_settings = {
		color = settings.color,
		shadow = settings.shadow,
		outline = settings.outline,
		font = font,
		size = 1
	}
	local words = parser.parse(text, word_settings)
	local text_metrics = {
		width = 0,
		height = 0,
		char_count = 0,
		img_count = 0,
		spine_count = 0,
	}
	local line_words = {}
	local line_width = 0
	local line_height = 0
	local paragraph_spacing = 0
	local position = vmath.vector3(settings.position)
	local word_count = #words
	for i = 1, word_count do
		local word = words[i]
		if word.image then
			text_metrics.img_count = text_metrics.img_count + 1
		elseif word.spine then
			text_metrics.spine_count = text_metrics.spine_count + 1
		else
			text_metrics.char_count = text_metrics.char_count + parser.length(word.text)
		end

		-- get font to use based on word tags
		local font_for_word = get_font(word, settings.fonts)

		-- get the previous word, so we can combine
		local previous_word
		if settings.combine_words then
			previous_word = line_words[#line_words]
			if not compare_words(previous_word, word) then
				previous_word = nil
			end
		end

		-- get metrics first, without creating the node (if possible)
		local word_metrics, combined_metrics, node = measure_node(word, font_for_word, previous_word)
		local should_create_node = true

		-- does the word fit on the line or does it overflow?
		local overflow = (settings.width and ((combined_metrics
			and (line_width - previous_word.metrics.total_width + combined_metrics.width)
			or (line_width + word_metrics.width)
		) > settings.width))

		if overflow and not word.nobr then
			-- overflow, position the words that fit on the line
			text_metrics.height = text_metrics.height + (line_height * line_increment_before * settings.line_spacing)
			position.x = settings.position.x
			position.y = settings.position.y - text_metrics.height
			position_words(line_words, line_width, line_height, position, settings)

			-- add the word that didn't fit to the next line instead
			line_words[#line_words + 1] = word

			-- update text metrics
			text_metrics.width = math.max(text_metrics.width, line_width)
			text_metrics.height = text_metrics.height + (line_height * line_increment_after * settings.line_spacing) + paragraph_spacing
			line_width = word_metrics.total_width
			line_height = word_metrics.height
			paragraph_spacing = 0
		else
			-- the word fits on the line, add it and update text metrics
			if combined_metrics then
				line_width = line_width - previous_word.metrics.total_width + combined_metrics.total_width
				line_height = math.max(line_height, combined_metrics.height)
				combine_node(previous_word, word, combined_metrics)
				should_create_node = false
			else
				line_width = line_width + word_metrics.total_width
				line_height = math.max(line_height, word_metrics.height)
				line_words[#line_words + 1] = word
			end
			text_metrics.width = math.max(text_metrics.width, line_width)
		end

		if should_create_node then
			word.node, word.metrics = create_node(word, settings.parent, font_for_word, node, word_metrics)
			gui.set_pivot(word.node, pivot)

			-- assign layer
			local layer = get_layer(word, settings.layers)
			if layer then
				gui.set_layer(word.node, layer)
			end
		else
			-- queue this word for deletion
			word.delete = true
		end

		if word.paragraph_end then
			local paragraph = word.paragraph
			if paragraph then
				paragraph_spacing = math.max(
					paragraph_spacing,
					line_height * (paragraph == true and settings.paragraph_spacing or paragraph)
				)
			end
		end

		-- handle line break
		if word.linebreak then
			-- position all words on the line up until the linebreak
			text_metrics.height = text_metrics.height + (line_height * line_increment_before * settings.line_spacing)
			position.x = settings.position.x
			position.y = settings.position.y - text_metrics.height
			position_words(line_words, line_width, line_height, position, settings)

			-- update text metrics
			text_metrics.height = text_metrics.height + (line_height * line_increment_after * settings.line_spacing) + paragraph_spacing
			line_height = word_metrics.height
			line_width = 0
			paragraph_spacing = 0
		end
	end

	-- position remaining words
	if #line_words > 0 then
		text_metrics.height = text_metrics.height + (line_height * line_increment_before * settings.line_spacing)
		position.x = settings.position.x
		position.y = settings.position.y - text_metrics.height
		position_words(line_words, line_width, line_height, position, settings)
		text_metrics.height = text_metrics.height + (line_height * line_increment_after * settings.line_spacing)
	end

	-- compact words table
	local j = 1
	for i = 1, word_count do
		local word = words[i]
		if not word.delete then
			words[j] = word
			j = j + 1
		end
	end
	for i = j, word_count do
		words[i] = nil
	end

	return words, text_metrics
end


--- Detected click/touch events on words with an anchor tag
-- These words act as "hyperlinks" and will generate a message when clicked
-- @param words Words to search for anchor tags
-- @param action The action table from on_input
-- @return true if a word was clicked, otherwise false
function M.on_click(words, action)
	for i=1,#words do
		local word = words[i]
		if word.anchor and gui.pick_node(word.node, action.x, action.y) then
			if word.tags and word.tags.a then
				local message = {
					node_id = gui.get_id(word.node),
					text = word.text,
					x = action.x, y = action.y,
					screen_x = action.screen_x, screen_y = action.screen_y
				}
				msg.post("#", word.tags.a, message)
				return true
			end
		end
	end
	return false
end


--- Get all words with a specific tag
-- @param words The words to search (as received from richtext.create)
-- @param tag The tag to search for. Nil to search for words without a tag
-- @return Words matching the tag
function M.tagged(words, tag)
	local tagged = {}
	for i=1,#words do
		local word = words[i]
		if not tag and not word.tags then
			tagged[#tagged + 1] = word
		elseif word.tags and word.tags[tag] then
			tagged[#tagged + 1] = word
		end
	end
	return tagged
end


--- Truncate a set of words such that only a specific number of characters
-- and images are visible
-- @param words List of words to truncate
-- @param length Maximum number of characters to show
-- @param options Optional table with truncate options. Available options are: words
-- @return Last visible word
function M.truncate(words, length, options)
	assert(words)
	assert(length)
	local last_visible_word = nil
	if options and options.words then
		for i=1, #words do
			local word = words[i]
			local visible = i <= length
			if visible then
				last_visible_word = word
			end
			gui.set_enabled(word.node, visible)
		end
	else
		local count = 0
		for i=1, #words do
			local word = words[i]
			local is_text_node = not word.image and not word.spine
			local word_length = is_text_node and utf8.len(word.text) or 1
			local visible = count < length
			if visible then
				last_visible_word = word
			end
			gui.set_enabled(word.node, visible)
			if count < length and is_text_node then
				local text = word.text
				-- partial word?
				if count + word_length > length then
					-- remove overflowing characters from word
					local overflow = (count + word_length) - length
					text = utf8.sub(word.text, 1, word_length - overflow)
				end
				gui.set_text(word.node, text)
				word.metrics = get_text_metrics(word, word.font, text)
			end
			count = count + word_length
		end
	end
	return last_visible_word
end


--- Split a word into it's characters
-- @param word The word to split
-- @return The individual characters
function M.characters(word)
	assert(word)

	local parent = gui.get_parent(word.node)
	local font = gui.get_font(word.node)
	local layer = gui.get_layer(word.node)
	local pivot = gui.get_pivot(word.node)

	local word_length = utf8.len(word.text)

	-- exit early if word is a single character or empty
	if word_length <= 1 then
		local char = deepcopy(word)
		char.node, char.metrics = create_node(char, parent, font)
		gui.set_pivot(char.node, pivot)
		gui.set_position(char.node, gui.get_position(word.node))
		gui.set_layer(char.node, layer)
		return { char }
	end

	-- split word into characters
	local chars = {}
	local position = gui.get_position(word.node)
	local position_x = position.x

	for i = 1, word_length do
		local char = deepcopy(word)
		chars[#chars + 1] = char
		char.text = utf8.sub(word.text, i, i)
		char.node, char.metrics = create_node(char, parent, font)
		gui.set_layer(char.node, layer)
		gui.set_pivot(char.node, pivot)

		local sub_metrics = get_text_metrics(word, font, utf8.sub(word.text, 1, i))
		position.x = position_x + sub_metrics.width - char.metrics.width
		gui.set_position(char.node, position)
	end

	return chars
end

---Removes the gui nodes created by rich text
function M.remove(words)
	assert(words)

	local num = #words
	for i=1,num do
		gui.delete_node(words[i].node)
	end
end


return M
/richtext/richtext.luaËdLJ =/richtext/richtext.luam !-   .  6    XÄ' 6 -  B&D Ätostring	hashid_counter prefix   —  	"6    B XÄ6 9  D XÄ6 96 99  B6 99  B6 99  B C K  zyxvector3
vmath
floor	mathnumber	typeÄÄÄˇv   ‘  \&6    B+   XÄ4  6   +  HÄ-  	 B-	  
 B	<	FR˜XÄ  L 
¿	next
table	type	deepcopy orig  orig_type copy 
 
 
orig_key orig_value   K   5  9  ' B  XÄ' L ^.-(%s*)$
matchtext  	 x   :6  9  ' B96  9  ' B9!L _
width _get_text_metricsguifont   Ò   F?9  8+    XÄ9   XÄ9   XÄ9  XÄ9   XÄ9  XÄ9   XÄ9  XÄ9  XÄ9  L regularbold_italicitalic	bold	font




word   fonts   font_settings font  Ü  
 5W9  9   XÄ96 9 B8L X
Ä9   XÄ96 9 B8L 96 9	 B8L get_font
fontsget_spine_scenespinescenes
spineget_textureguiimages
image	nodeword  layers  node  ∞ 
  >Éb
   XÄ
  XÄ9  9  XÄ9 9 XÄ9 9 XÄ9 9 XÄ9 9 XÄ+ L 9 9 XÄ+ L 
  XÄ  XÄ+ L 6  BHÄ8		 X	Ä+	 L	 FR˘6  BHÄ8		 X	Ä+	 L	 FR˘+ L 
pairs	tags	fontoutlineshadow
color	size

one  ?two  ?one_tags "two_tags  "  k v  
  k v   â aÉ&9 -  9 XÄ9!=X	Ä9 -  9 XÄ9 !=)  9 -  9 XÄ)  )  ) 	  )
 MÄ8 99)   XÄ99 Oı)  XÄ9!	#	)   ) M,Ä8
	 9
  XÄ9	!=	6
 99
 B9	 =	XÄ9
  XÄ9  XÄ6
 99
-  B AXÄ6
 99
 B99
9  =+  <	 O‘K  ¿	¿image_pixel_grid_snap
image	nodeset_positionguiy
spine
widthtotal_widthmetricsALIGN_JUSTIFYALIGN_CENTERxALIGN_RIGHT
align	
!!!!!######$$&M round words  bline_width  bline_height  bposition  bsettings  bspacing Nwords_width word_count   i 
word 	- - -i +word *   
 )h∞6    B6   B XÄ-  9  D XÄ)  )   ) MÄ8 9  XÄ9 XÄ+ XÄ+   XÄ- 99	B  X	Ä)  OÎL K   ¿¿	textlen
spine
imagelengthstring	typeassert										parser utf8 text  *count   i word is_text_node 	
 ò  <k¿6  9-  -  B6  9 - ' B A6  9 6  9B6  9 9 9B6  9	 6
 99 B A6  9 6 9 9B A6  9 B4  99 "=99 "=99 "=  J ¿¿yheight
widthxtotal_widthget_size	anim	hashplay_flipbook	sizevector3
vmathset_scaletexture
imageset_textureSIZE_MODE_AUTOset_size_modeboxset_idnew_box_nodegui				
V3_ZERO new_id word  =node 7size 'metrics  ‰  1`“6  9-  9 9B6  9 - ' B A6  9 6  9B6  9 6 9	9
 B A6  9 9 96  9B6  9 B4  9=9=9=  J ¿¿yheight
widthxtotal_widthget_sizePLAYBACK_LOOP_FORWARD	animplay_spine_anim	sizevector3
vmathset_scaleSIZE_MODE_AUTOset_size_modeset_id
scene
spinenew_spine_nodegui		

V3_ZERO new_id word  2node +size !
metrics 	 Ù 	
?¢‚  XÄ9    XÄ9 +  -  9 B	  XÄ6 9 ' B )  =)  =99	 "=X"Ä6 9  B 99	 "=99	 "=- 9  B )   XÄ9 -  B"9	 " =XÄ9=L ¿¿¿	sizeheighttotal_width
width|get_text_metricsguilen	font	text 					utf8 get_trailing_whitespace get_space_width word  @font  @text  @metrics 8trailing_whitespace & ˆ 
 Gé˝6  9-  9 B6  9 - ' B A6  9  B6  9 9 B9   XÄ6  9	 9 B9
   XÄ6  9 9
 B6  9 - 9 "B  XÄ-    B 6  9 6  9B6  9 6 999)	  B A  J ¿¿¿¿height
widthvector3
vmathset_sizeSIZE_MODE_MANUALset_size_mode	sizeset_scaleset_outlineoutlineset_shadowshadow
colorset_colorset_fonttextnodeset_id	textnew_text_nodegui							





V3_ZERO new_id V3_ONE get_text_metrics word  Hfont  Hmetrics  Hnode B ‡ 
 
 >ç9  9 &=  = 6 99 6 999)	  B A6 9	9  BK  set_textheight
widthvector3
vmath	nodeset_sizeguimetrics	textprevious_word  word  metrics  text  Ì 	 *Üñ9    XÄ  XÄ-    B  XÄ9   XÄ  XÄ-   B  XÄ-     B  6 9  B6 9 + B  J ¿¿¿set_inherit_alphaset_parentgui
spine
image






create_box_node create_spine_node create_text_node word  +parent  +font  +node  +metrics  + ◊  &ú®, 9    XÄ-    B  XÄ9   XÄ-   B  XÄ-    B   XÄ-    9	9
 &	
	B    J ¿¿¿	text
spine
image								create_box_node create_spine_node get_text_metrics word  'font  'previous_word  'node %metrics  %combined_metrics  % ä !=¬’ø∫6    ' B6   ' B  XÄ4  9  XÄ-  9=9  XÄ-  9=9  XÄ4  =998  XÄ5	 6  B=
<9  XÄ4  =999  XÄ4  =999  XÄ4  =999  XÄ4  =9  XÄ- =9  XÄ- =9  XÄ- =9  XÄ- =9  XÄ) =9  XÄ*  =9  XÄ+ =9  XÄ+ =9-  9 XÄ9  XÄ6 ' B)  ) 6 99-  9 XÄ*  *  6 9X	Ä9-  9 XÄ) )  6 95  9=9=9==!- 9"  	 B5# 4	  )
  )  )  6$ 9%9B )  ) MÁÄ89&  XÄ9'='XÄ9(  XÄ9)=)XÄ9*- 9+9,B =*-  9B+  9  X	Ä	 8	-   B  XÄ+  -    B+ 9  XÄ  XÄ9-9.!
9   XÄ9 
9  XÄ+ XÄ+   X,Ä9/  X)Ä90"9" =0991=199290!=2- 	 
     B	 <	63 949
 B=90"9"  =09
.90)  X%Ä  XÄ9-9.!
9. 
63 94 90B -	    B+ XÄ9. 

63 94 90B 	 <	63 949
 B=  XÄ-
  96    B=-=56 9795 B-  9B  XÄ6 9895 BXÄ+ =99:  XÄ9;  XÄ63 94  XÄ9  XÄ "B 9<  XÄ90"9" =0991=199290!=2- 	 
     B90"9"  =090)
  )  O	 )   XÄ90"9" =0991=199290!=2- 	 
    B90"9" =0) )  ) MÄ899  XÄ<O˘  ) MÄ+  <O˝  J ¿¿¿¿ ¿¿¿¿¿¿¿¿linebreakparagraphparagraph_enddeleteset_layerset_pivotparent	nodemax	mathyxheight	nobrtotal_widthmetrics	textlengthchar_countspine_count
spineimg_count
imagevector3
vmath char_count height img_count spine_count 
width 
parse	font 	sizePIVOT_SWVALIGN_BOTTOMPIVOT_WVALIGN_MIDDLEPIVOT_NWgui8Width must be specified if text should be justified
error
widthALIGN_JUSTIFYcombine_wordsimage_pixel_grid_snapparagraph_spacingline_spacingpositionoutlineshadow
colorspinescenesimageslayersregular  	hash
fontsVALIGN_TOPvalignALIGN_LEFT
alignYou must provide a fontYou must provide a textassertÄÄÄˇ							






 !""'(())**+...../6789::::;<<<<=>>>????@@@AAAACCCCCCCGGGGJKKKLLMMMMMMNSSSSSTWWWXXXXXXXYYYYZZZZZZ\\\\\^^^^^^___`````aaaaaaadddgggggghhhhhhhijkknnoooooppppppqqqqqrrttuuuuuuvvvxxxxxx{{|||||||||}}}}}ÄÄÄÄÅÅÇÇÇÇÇÉÜÜâââäããååçéééééééåèîîîññññññóóóòòòòòôôôôôôôúúúúúúúùûü<§§§§••••••¶¶¶ßßßßß®®®®®®®©©©©©©≠ÆÆÆÆØ∞∞∞±≤Æµµµµ∂∂µπππM V4_ONE V4_ZERO V3_ZERO parser get_font compare_words measure_node position_words combine_node create_node get_layer text  √font  √settings  √line_increment_before vÕline_increment_after Ãpivot  word_settings Øwords ™text_metrics ©line_words ®line_width ßline_height ¶paragraph_spacing •position °word_count †Ë Ë Ëi Êword Âfont_for_word Ãprevious_word Àword_metrics ∫combined_metrics  ∫node  ∫should_create_node πoverflow •layer gparagraph j Q  i word 	  i  ì   3cÅ)   ) M-Ä8 9   X(Ä6 999	9
B  X Ä9  XÄ99  XÄ5	 6 99	B=
9=9=9=9=9=6 9'	 9
9

 B+ L O”+ L #	postmsgscreen_yscreen_x	textnode_id  get_ida	tagsyx	nodepick_nodeguianchor				words  4action  4. . .i ,word +message "	 ƒ 	 Gô4  )   ) MÄ8   XÄ9   XÄ  <X
Ä9   X	Ä9 8  X	Ä  <OÎL 	tags
words  tag  tagged   i word  é  dù≠'6    B6   B+    XÄ9  XÄ)   ) MÄ8  X	Ä+	 X
Ä+	  	 X
Ä 6
 9

9	 B
OÒXCÄ)  )   ) M>Ä8	 9
	 
 X
Ä9
	

 XÄ+
 XÄ+
  
 XÄ-  99	B  XÄ)   XÄ+ XÄ+   XÄ	 6 99	 B XÄ 
 XÄ9	  X	Ä !-  9	9	) !B 6 9
9	 B- 	 9	 B=	 O¬L ¿¿	fontmetricsset_textsub	textlen
spine
image	nodeset_enabledgui
wordsassert	     !!!!!!#&utf8 get_text_metrics words  elength  eoptions  elast_visible_word ]  i word visible count B? ? ?i =word <is_text_node 	3word_length 	*visible %text overflow  ö x¢⁄'6    B6 99 B6 99 B6 99 B6 99 B-  99 B)  XÄ-   B-  	 
 B=	=6 9
9	 B6 996	 9		9
 B	 A6 99	 B4 >L 4  6 99 B9)	 
 ) M	4Ä-   B  <-  99   B=-    B=	=6 99 B6 9
9 B-    -  99 )  B A9 9	9!=6 99 BO	ÃL ¿
¿¿¿
widthsubxset_layerget_positionset_positionset_pivotmetrics	textlenget_pivotget_layerget_font	nodeget_parentguiassert!!!!!!!!!!""""""#####&utf8 deepcopy create_node get_text_metrics word  yparent qfont mlayer ipivot eword_length achar chars >position :position_x 95 5 5i 3char 0sub_metrics % é   +Ñ6    B  )  ) MÄ6 98 9BO˙K  	nodedelete_nodeguiassertwords  num   i  ≠  , TË è6   ' B 6  ' B4  6 ' B=6 ' B=6 ' B=6 ' B=6 ' B=6 '	 B=	6 '
 B=
6 9)  B6 9) B6 9)  B6 9) B)  3 3	 3
 3 3 3 3 3 3 3 =3 3 3 3 3 3 3 3! = 3# ="3% =$3' =&3) =(3+ =*2  ÄL  remove characters truncate tagged on_click create        length         vector3vector4
vmathVALIGN_BOTTOMVALIGN_MIDDLEVALIGN_TOPALIGN_JUSTIFYALIGN_RIGHTALIGN_LEFT	hashALIGN_CENTERrichtext.utf8richtext.parserequire                   	 	 	 	                               # 2 7 < T _ ~ © Ω ∞ œ ﬂ ˙ 
%5˘?$T-ÅZãÑééparser Qutf8 NM MV4_ZERO  -V4_ONE )V3_ZERO %V3_ONE !id_counter  new_id round deepcopy get_trailing_whitespace get_space_width get_font get_layer compare_words position_words create_box_node create_spine_node get_text_metrics create_text_node combine_node create_node measure_node   "ËdLJ=/richtext/richtext.luam !-   .  6    XÄ' 6 -  B&D Ätostring	hashid_counter prefix   —  	"6    B XÄ6 9  D XÄ6 96 99  B6 99  B6 99  B C K  zyxvector3
vmath
floor	mathnumber	typeÄÄÄˇv   ‘  \&6    B+   XÄ4  6   +  HÄ-  
 B-	   B	<	FR˜XÄ  L 
¿	next
table	type	deepcopy orig  orig_type copy 
 
 
orig_key orig_value   K   5  9  ' B  XÄ' L ^.-(%s*)$
matchtext  	 x   :6  9  ' B96  9  ' B9!L _
width _get_text_metricsguifont   Ò   F?9  8+    XÄ9   XÄ9   XÄ9  XÄ9   XÄ9  XÄ9   XÄ9  XÄ9  XÄ9  L regularbold_italicitalic	bold	font




word   fonts   font_settings font  Ü  
 5W9  9   XÄ96 9 B8L X
Ä9   XÄ96 9 B8L 96 9	 B8L get_font
fontsget_spine_scenespinescenes
spineget_textureguiimages
image	nodeword  layers  node  ∞   >Éb
   XÄ
  XÄ9  9  XÄ9 9 XÄ9 9 XÄ9 9 XÄ9 9 XÄ+ L 9 9 XÄ+ L 
  XÄ  XÄ+ L 6  BHÄ8		 X	Ä+	 L	 FR˘6  BHÄ8		 X	Ä+	 L	 FR˘+ L 
pairs	tags	fontoutlineshadow
color	size

one  ?two  ?one_tags "two_tags  "  k v  
  k v   â aÉ&9 -  9 XÄ9!=X	Ä9 -  9 XÄ9 !=)  9 -  9 XÄ)  )  ) 	  )
 MÄ8 99)   XÄ99 Oı)  XÄ9!	#	)   ) M,Ä8
	 9
  XÄ9	!=	6
 99
 B9	 =	XÄ9
  XÄ9  XÄ6
 99
-  B AXÄ6
 99
 B99
9  =+  <	 O‘K  ¿	¿image_pixel_grid_snap
image	nodeset_positionguiy
spine
widthtotal_widthmetricsALIGN_JUSTIFYALIGN_CENTERxALIGN_RIGHT
align	
!!!!!######$$&M round words  bline_width  bline_height  bposition  bsettings  bspacing Nwords_width word_count   i 
word 	- - -i +word *    )h∞6    B6   B XÄ-  9  D XÄ)  )   ) MÄ8 9  XÄ9 XÄ+ XÄ+   XÄ- 99
B  X	Ä)  OÎL K   ¿¿	textlen
spine
imagelengthstring	typeassert										parser utf8 text  *count   i word is_text_node 	
 ò  <k¿6  9-  -  B6  9 - ' B A6  9 6  9B6  9 9 9B6  9	 6
 99 B A6  9 6 9 9B A6  9 B4  99 "=99 "=99 "=  J ¿¿yheight
widthxtotal_widthget_size	anim	hashplay_flipbook	sizevector3
vmathset_scaletexture
imageset_textureSIZE_MODE_AUTOset_size_modeboxset_idnew_box_nodegui				
V3_ZERO new_id word  =node 7size 'metrics  ‰  1`“6  9-  9 9B6  9 - ' B A6  9 6  9B6  9 6 9	9
 B A6  9 9 96  9B6  9 B4  9=9=9=  J ¿¿yheight
widthxtotal_widthget_sizePLAYBACK_LOOP_FORWARD	animplay_spine_anim	sizevector3
vmathset_scaleSIZE_MODE_AUTOset_size_modeset_id
scene
spinenew_spine_nodegui		

V3_ZERO new_id word  2node +size !
metrics 	 Ù 

?¢‚  XÄ9    XÄ9 +  -  9 B	  XÄ6 9 ' B )  =)  =99	 "=X"Ä6 9  B 99	 "=99	 "=- 9  B )   XÄ9 - 	 B"9	 " =XÄ9=L ¿¿¿	sizeheighttotal_width
width|get_text_metricsguilen	font	text 					utf8 get_trailing_whitespace get_space_width word  @font  @text  @metrics 8trailing_whitespace & ˆ  Gé˝6  9-  9 B6  9 - '	 B A6  9  B6  9 9 B9   XÄ6  9	 9 B9
   XÄ6  9 9
 B6  9 - 9 "B  XÄ-    B 6  9 6  9B6  9 6 99	9
)  B A  J ¿¿¿¿height
widthvector3
vmathset_sizeSIZE_MODE_MANUALset_size_mode	sizeset_scaleset_outlineoutlineset_shadowshadow
colorset_colorset_fonttextnodeset_id	textnew_text_nodegui							





V3_ZERO new_id V3_ONE get_text_metrics word  Hfont  Hmetrics  Hnode B ‡  
 >ç9  9 &=  = 6 99 6 99	9
)  B A6 9	9  BK  set_textheight
widthvector3
vmath	nodeset_sizeguimetrics	textprevious_word  word  metrics  text  Ì 
 *Üñ9    XÄ  XÄ-    B  XÄ9   XÄ  XÄ-   B  XÄ-    	 B  6 9  B6 9 + B  J ¿¿¿set_inherit_alphaset_parentgui
spine
image






create_box_node create_spine_node create_text_node word  +parent  +font  +node  +metrics  + ◊  &ú®, 9    XÄ-    B  XÄ9   XÄ-   B  XÄ-   	 B   XÄ-   	 9
9 &

B    J ¿¿¿	text
spine
image								create_box_node create_spine_node get_text_metrics word  'font  'previous_word  'node %metrics  %combined_metrics  % ä "=¬’ø∫6    ' B6   ' B  XÄ4  9  XÄ-  9=9  XÄ-  9=9  XÄ4  =998  XÄ5	 6  B=
<9  XÄ4  =999  XÄ4  =999  XÄ4  =999  XÄ4  =9  XÄ- =9  XÄ- =9  XÄ- =9  XÄ- =9  XÄ) =9  XÄ*  =9  XÄ+ =9  XÄ+ =9-  9 XÄ9  XÄ6 ' B)  ) 6 99-  9 XÄ*  *  6 9X	Ä9-  9 XÄ) )  6 95  9=9=9==!- 9"	  
 B5# 4	  )
  )  )  6$ 9%9B )  ) MÁÄ89&  XÄ9'='XÄ9(  XÄ9)=)XÄ9*- 9+9,B =*-  9B+  9  X	Ä	 8	-   B  XÄ+  -    B+ 9  XÄ  XÄ9-9.!
9   XÄ9 
9  XÄ+ XÄ+   X,Ä9/  X)Ä90"9" =0991=199290!=2- 	 
    ! B	 <	63 949
 B=90"9"  =09
.90)  X%Ä  XÄ9-9.!
9. 
63 94 90B -	    B+ XÄ9. 

63 94 90B 	 <	63 949
 B=  XÄ-
  96   ! B=-=56 9795 B-  9B  XÄ6 9895 BXÄ+ =99:  XÄ9;  XÄ63 94  XÄ9  X Ä "B 9<  XÄ90"9" =0991=199290!=2- 	 
    ! B90"9"  =090)
  )  O	 )   XÄ90"9" =0991=199290!=2- 	 
    B90"9" =0) )  ) MÄ899  XÄ<O˘  ) MÄ+  <O˝  J ¿¿¿¿ ¿¿¿¿¿¿¿¿linebreakparagraphparagraph_enddeleteset_layerset_pivotparent	nodemax	mathyxheight	nobrtotal_widthmetrics	textlengthchar_countspine_count
spineimg_count
imagevector3
vmath char_count height img_count spine_count 
width 
parse	font 	sizePIVOT_SWVALIGN_BOTTOMPIVOT_WVALIGN_MIDDLEPIVOT_NWgui8Width must be specified if text should be justified
error
widthALIGN_JUSTIFYcombine_wordsimage_pixel_grid_snapparagraph_spacingline_spacingpositionoutlineshadow
colorspinescenesimageslayersregular  	hash
fontsVALIGN_TOPvalignALIGN_LEFT
alignYou must provide a fontYou must provide a textassertÄÄÄˇ							






 !""'(())**+...../6789::::;<<<<=>>>????@@@AAAACCCCCCCGGGGJKKKLLMMMMMMNSSSSSTWWWXXXXXXXYYYYZZZZZZ\\\\\^^^^^^___`````aaaaaaadddgggggghhhhhhhijkknnoooooppppppqqqqqrrttuuuuuuvvvxxxxxx{{|||||||||}}}}}ÄÄÄÄÅÅÇÇÇÇÇÉÜÜâââäããååçéééééééåèîîîññññññóóóòòòòòôôôôôôôúúúúúúúùûü<§§§§••••••¶¶¶ßßßßß®®®®®®®©©©©©©≠ÆÆÆÆØ∞∞∞±≤Æµµµµ∂∂µπππM V4_ONE V4_ZERO V3_ZERO parser get_font compare_words measure_node position_words combine_node create_node get_layer text  √font  √settings  √line_increment_before vÕline_increment_after Ãpivot  word_settings Øwords ™text_metrics ©line_words ®line_width ßline_height ¶paragraph_spacing •position °word_count †Ë Ë Ëi Êword Âfont_for_word Ãprevious_word Àword_metrics ∫combined_metrics  ∫node  ∫should_create_node πoverflow •layer gparagraph j Q  i word 	  i  ì   3cÅ)   ) M-Ä8 9   X(Ä6 99	9
9B  X Ä9  XÄ99  XÄ5	 6 99
B=
9=9=9=9=9=6 9'
 99 B+ L O”+ L #	postmsgscreen_yscreen_x	textnode_id  get_ida	tagsyx	nodepick_nodeguianchor				words  4action  4. . .i ,word +message "	 ƒ 	 Gô4  )   ) MÄ8   XÄ9   XÄ  <X
Ä9   X	Ä9 8  X	Ä  <OÎL 	tags
words  tag  tagged   i word  é  dù≠'6    B6   B+    XÄ9  XÄ)   ) MÄ8  X	Ä+	 X
Ä+	  	 X
Ä 6
 9

9	 B
OÒXCÄ)  )   ) M>Ä8	 9
	 
 X
Ä9
	

 XÄ+
 XÄ+
  
 XÄ-  99	B  XÄ)   XÄ+ XÄ+   XÄ	 6 99	 B XÄ 
 XÄ9	  X	Ä !-  9	9	) !B 6 9
9	 B- 	 9	 B=	 O¬L ¿¿	fontmetricsset_textsub	textlen
spine
image	nodeset_enabledgui
wordsassert	     !!!!!!#&utf8 get_text_metrics words  elength  eoptions  elast_visible_word ]  i word visible count B? ? ?i =word <is_text_node 	3word_length 	*visible %text overflow  ö x¢⁄'6    B6 99 B6 99 B6 99 B6 99 B-  99 B)  XÄ-   B- 	 
  B=	=6 9
9	
 B6 99	6
 9

9 B
 A6 99	
 B4 >L 4  6 99	 B9)	 
 ) M	4Ä-   B  <-  99   B=-    B=	=6 99 B6 9
9 B-    -  99 )  B A9 9	9!=6 99 BO	ÃL ¿
¿¿¿
widthsubxset_layerget_positionset_positionset_pivotmetrics	textlenget_pivotget_layerget_font	nodeget_parentguiassert!!!!!!!!!!""""""#####&utf8 deepcopy create_node get_text_metrics word  yparent qfont mlayer ipivot eword_length achar chars >position :position_x 95 5 5i 3char 0sub_metrics % é 	  +Ñ6    B  )  ) MÄ6 98 9BO˙K  	nodedelete_nodeguiassertwords  num   i  ≠  , TË è6   ' B 6  ' B4  6 ' B=6 ' B=6 ' B=6 ' B=6 ' B=6 '	 B=	6 '
 B=
6 9)  B6 9) B6 9)  B6 9) B)  3 3	 3
 3 3 3 3 3 3 3 =3 3 3 3 3 3 3 3! = 3# ="3% =$3' =&3) =(3+ =*2  ÄL  remove characters truncate tagged on_click create        length         vector3vector4
vmathVALIGN_BOTTOMVALIGN_MIDDLEVALIGN_TOPALIGN_JUSTIFYALIGN_RIGHTALIGN_LEFT	hashALIGN_CENTERrichtext.utf8richtext.parserequire                   	 	 	 	                               # 2 7 < T _ ~ © Ω ∞ œ ﬂ ˙ 
%5˘?$T-ÅZãÑééparser Qutf8 NM MV4_ZERO  -V4_ONE )V3_ZERO %V3_ONE !id_counter  new_id round deepcopy get_trailing_whitespace get_space_width get_font get_layer compare_words position_words create_box_node create_spine_node get_text_metrics create_text_node combine_node create_node measure_node   richtext.parserichtext.utf8/richtext/parse.luac/richtext/utf8.luac" 